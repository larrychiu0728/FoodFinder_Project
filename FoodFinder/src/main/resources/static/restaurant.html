<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¤å»³æŸ¥è©¢</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<div id="container">
  <form class="searchForm">
    <div class="type-group">
      <label for="type">é¡åˆ¥:</label>
      <select id="type" v-model="searchForm.type">
        <option value="">è«‹é¸æ“‡</option>
        <option v-for="type in typeList" :value="type.id" :key="type.id">
          {{ type.name }}
        </option> 
      </select>

      <label>åˆ†æ•¸ç¯©é¸ï¼š</label>
      <select v-model="searchForm.scoreRange">
        <option value="">å…¨éƒ¨</option>
        <option v-for="option in scoreRangeOptions" :key="option.value" :value="option.value">
          {{ option.label }}
        </option>
      </select>
    </div>

    <button type="button" @click="handleSearchButtonClick">æœå°‹</button>
    <button type="button" @click="clear">æ¸…é™¤</button>
  </form>

  <div class="top">
    <table v-if="restaurantList.length > 0">
      <thead>
      <tr>
        <th>åå­—</th>
        <th>é¡åˆ¥</th>
        <th>åœ°å€</th>
        <th>åˆ†æ•¸</th>
        <th>å‚™è¨»</th>
      </tr>
      </thead>
      <tbody>
      <tr v-for="restaurant in restaurantList" :key="restaurant.id" 
            @click="select(restaurant)" :class="{ selected: selected && selected.id === restaurant.id }">
        <td>{{ restaurant.name }}</td>
        <td>{{ restaurant.type.name }}</td>
        <td>{{ restaurant.address }}</td>
        <td>{{ restaurant.rating }}</td>
        <td @dblclick="openNoteEditor(restaurant)">
          {{ restaurant.note || 'ï¼ˆç„¡ï¼‰' }}
        </td>
      </tr>
      </tbody>
    </table>
    <p v-else style="margin-top: 1em;">ğŸ” æŸ¥ç„¡è³‡æ–™</p>
    <div class="pagination-container">
      <button @click="currentPage--" :disabled="currentPage <= 1">ä¸Šä¸€é </button>
      <span>ç¬¬ {{ currentPage }} é </span>
      <button @click="currentPage++" :disabled="currentPage * pageSize >= totalItems">ä¸‹ä¸€é </button>
    </div>
  </div>

  <hr class="divider" />

  <div class="bottom">
    <div class="left-map" v-if="selected">
    <iframe
      width="100%"
      height="100%"
      :src="'https://www.google.com/maps?q=' + encodeURIComponent(selected.address) + '&output=embed'"
      frameborder="0"
    ></iframe>
  </div>
    <div class="right-image" v-if="selected">
      <img
        v-for="image in restaurantImages"
        :key="image.id"
        :src="'/images/' + image.imageUrl"
        alt="é¤å»³åœ–ç‰‡"
      />
    </div>
  </div>

  <div v-if="editingNoteRestaurant" class="note-editor">
    <div class="note-editor-box">
      <h3>ç·¨è¼¯å‚™è¨»</h3>
      <textarea v-model="editingNoteText" rows="4" cols="40"></textarea>
      <div class="actions">
        <button @click="saveNote">ğŸ’¾ ä¿å­˜</button>
        <button @click="cancelNoteEdit">âŒ å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="module">
  import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

  createApp({
    data() {
      return {
        searchForm: {
          type: '',
          scoreRange: ''
        },
        scoreRangeOptions: [
          { label: '3.0 ~ 3.4', value: '3.0-3.4' },
          { label: '3.5 ~ 3.9', value: '3.5-3.9' },
          { label: '4.0 ~ 4.4', value: '4.0-4.4' },
          { label: '4.5 ~ 5.0', value: '4.5-5.0' }
        ],
        restaurantList: [],
        typeList: [],
        selected: null,
        restaurantImages: [],
        currentPage: 1,
        pageSize: 5,
        totalItems: 0,
        editingNoteRestaurant: null,
        editingNoteText: ''
      };
    },
    methods: {
      async doSearch() {
        const params = {
          page: this.currentPage - 1, // Spring é æ•¸å¾ 0 é–‹å§‹
          size: this.pageSize,
        };
        if (this.searchForm.type) {
          params.typeId = this.searchForm.type;
        }

        if (this.searchForm.scoreRange) {
          const [min, max] = this.searchForm.scoreRange.split('-');
          params.minScore = parseFloat(min);
          params.maxScore = parseFloat(max);
        }

        try {
          const result = await axios.get('/lists', { params });

          this.restaurantList = result.data.content; // Page çš„è³‡æ–™åœ¨ content è£¡
          this.totalItems = result.data.totalElements;

          if (this.restaurantList.length > 0) {
            this.select(this.restaurantList[0]);
          }
        } catch (error) {
          console.error('æŸ¥è©¢å¤±æ•—ï¼š', error);
          this.restaurantList = [];
        }
      },
      async loadTypes() {
        try {
          const result = await axios.get('/types');
          this.typeList = result.data; // å‡è¨­å¾Œç«¯å›å‚³é™£åˆ— [{id, type, name}]
        } catch (error) {
          console.error('è®€å–é¡åˆ¥å¤±æ•—', error);
        }
      },
      clear() {
        this.searchForm.type = '';
        this.searchForm.scoreRange = '';
        this.restaurantList = [];
      },
      async select(restaurant) {
        this.selected = restaurant;

        try {
          const res = await axios.get('/images', {
            params: { restaurantId: restaurant.id }
          });
          this.restaurantImages = res.data;
        } catch (error) {
          console.error('è®€å–åœ–ç‰‡å¤±æ•—', error);
          this.restaurantImages = [];
        }
      },
      handleSearchButtonClick() {
        if (this.currentPage !== 1) {
          this.currentPage = 1; // æœƒè§¸ç™¼ watch â†’ doSearch()
        } else {
          this.doSearch(); // ç›®å‰åœ¨ç¬¬ 1 é ï¼Œwatch ä¸æœƒå‹•ï¼Œæ‰€ä»¥è‡ªå·± call
        }
      },
      openNoteEditor(restaurant) {
        this.editingNoteRestaurant = restaurant;
        this.editingNoteText = restaurant.note || '';
      },
      cancelNoteEdit() {
        this.editingNoteRestaurant = null;
        this.editingNoteText = '';
      },
      async saveNote() {
        const restaurant = this.editingNoteRestaurant;
        try {
          await axios.put(`/restaurant/${restaurant.id}/note`, {
            note: this.editingNoteText
          });
          // æ›´æ–°ç•«é¢
          restaurant.note = this.editingNoteText;
        } catch (err) {
          console.error('å„²å­˜å¤±æ•—', err);
        } finally {
          this.editingNoteRestaurant = null;
          this.editingNoteText = '';
        }
      }
    },
    watch: {
      currentPage() {
        this.doSearch();
      }
    },
    mounted() {
      const urlParams = new URLSearchParams(window.location.search);
      const typeFromUrl = urlParams.get('typeId');
      if (typeFromUrl) {
        this.searchForm.type = parseInt(typeFromUrl);
      }
      this.loadTypes();  // æŠ“ä¸‹æ‹‰é¸å–®çš„è³‡æ–™
      this.doSearch();
    }
  }).mount('#container');
</script>
</body>
</html>